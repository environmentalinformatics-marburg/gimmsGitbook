```{r knitsetup, echo=FALSE, results='hide', warning=FALSE, message=FALSE, cache=FALSE}
opts_knit$set(base.dir='./', fig.path='', out.format='md')
opts_chunk$set(prompt=FALSE, comment='', results='markup')
# See yihui.name/knitr/options for more Knitr options.
##### Put other setup R code here


# end setup chunk
```
# 'gimms' goes parallel

At this point, it is time for some considerations on code performance. I constructed the single **gimms** functions to the best of my knowledge, but there is still room for further speed gains, which particularly applies to data download and rasterization. If you are not already familiar with the basic principles of how to go parallel in R, this [short tutorial on G-Forge](http://gforge.se/2015/02/how-to-go-parallel-in-r-basics-tips/) will provide you with valuable insights.

<center>
  <img src="https://i2.wp.com/gforge.se/wp-content/uploads/2015/02/Horse_power_smudge_9000.jpg" alt="parallel" style="width: 500px;"/><br>
  <small>Source: http://gforge.se/wp-content/uploads/2015/02/Horse_power_smudge_9000.jpg</small>
</center>

### Parallel downloads

Provided that you have a sufficiently fast active internet connection, it is quite easy to distribute the actual GIMMS download procedure to multiple nodes. Say you want to download all files from the first half of the year 2000, the standard approach would look as follows. 

```{r download, eval = FALSE}
system.time(
  local_files <- downloadGimms(x = as.Date("2000-01-01"), y = as.Date("2000-06-30"), 
                               dsn = paste0(getwd(), "/data"), overwrite = TRUE)
)
#   user  system elapsed 
#  0.336   2.736  84.654 
```

And here is the parallel version which, on my machine and with my internet connections, performs roughly 2.5 times faster.

```{r download_parallel, eval = FALSE}
system.time({
  ## avl files
  gimms_files <- updateInventory()
  ## files from 2000
  gimms_files <- gimms_files[grep("geo00", gimms_files)]
  ## files from jan-jun
  gimms_files <- gimms_files[1:12]
  
  ## initialize parallel backend with 3 nodes
  library(doParallel)
  cl <- makeCluster(3)
  registerDoParallel(cl)
  
  ## download single files
  local_files <- foreach(i = gimms_files, .combine = "c", 
                         .packages = "gimms") %dopar% {
    downloadGimms(i, dsn = paste0(getwd(), "/data"), overwrite = TRUE)
  }
  
  ## close parallel backend
  stopCluster(cl)
})
#   user  system elapsed 
#  0.181   0.154  32.919 
```

### Parallel rasterization
Speed gains can furthermore be achieved when running `rasterizeGimms` with the `raster::writeRaster` option enabled, i.e., parameter `filename` specified. When run in parallel, the operation performs considerably faster as compared to the base implementation. 

```{r parallel, message = FALSE, eval = FALSE}
## first, the base version from above
system.time(
  local_rasters <- rasterizeGimms(local_files, filename = local_files, 
                                  format = "GTiff", overwrite = TRUE)
)
#   user  system elapsed 
# 62.916   4.594  70.480 

## next, the parallelized version
rasterizeGimmsParallel <- function(files, nodes = 3, ...) {
  
  # create and register parallel backend
  library(doParallel)
  cl <- makeCluster(nodes)
  registerDoParallel(cl)
  
  # loop over 'x' and process single files in parallel
  ls_rst <- foreach(i = files, .packages = "gimms", 
                    .export = ls(envir = globalenv())) %dopar% {
                      rasterizeGimms(i, filename = i, ...)
                    }
  
  # stack layers
  rst <- raster::stack(ls_rst)
  
  # deregister parallel backend
  stopCluster(cl)
  
  # return layers
  return(rst)
}

system.time(
  rasterizeGimmsParallel(local_files, 
                         format = "GTiff", overwrite = TRUE)
)
#   user  system elapsed 
#  0.122   0.105  37.298
```

In the context of parallel processing, feel free to also browse the compendium of advanced applications based on GIMMS NDVI<sub>3g</sub> data herein after. There are some more examples included demonstrating the reasonable use of **doParallel** functionality `r citep(citation("doParallel"))` along with the **gimms** package.

```{r references, echo = FALSE, eval = FALSE}
## update bibliography
knitcitations::write.bibtex(file = "references.bib", append = FALSE)
```